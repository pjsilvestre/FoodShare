extends layout

block content
    link(rel="stylesheet" href="/stylesheets/donation-map.css")
    if user
        include partials/navbar-authenticated
        style.
            html, body, #map {
                height: calc(100% - 30px);
                width: 100%;
            }
        body
            #map

    else
        include partials/navbar-unauthenticated
        div(class="container")        
        style.
            html, body, #map {
                height: calc(100% - 30px);
                width: 100%;
            }
        body
            #map

    script(src="https://www.gstatic.com/firebasejs/7.5.0/firebase-app.js")
    script(src="https://www.gstatic.com/firebasejs/7.5.0/firebase-firestore.js")

    script.
        var map;
        var firebaseConfig = {
            apiKey: "AIzaSyCEV6HqDHYuIM1eAGrUw3tGAfIV-l4d88Y",
            authDomain: "foodshare-d3eee.firebaseapp.com",
            databaseURL: "https://foodshare-d3eee.firebaseio.com",
            projectId: "foodshare-d3eee",
            storageBucket: "foodshare-d3eee.appspot.com",
            messagingSenderId: "265720897822",
            appId: "1:265720897822:web:92ec456677a9e3716a690f",
            measurementId: "G-KS792GTVDM"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
            center: {lat: 37.3351874, lng: -121.88107150000002},
            zoom: 17,
            styles: [{
                featureType: 'poi',
                stylers: [{ visibility: 'off' }]  // Turn off POI.
            },
            {
                featureType: 'transit.station',
                stylers: [{ visibility: 'off' }]  // Turn off bus, train stations etc.
            }],
            disableDoubleClickZoom: true,
            streetViewControl: false,
            });

            firebase.firestore().collection('donations').get()
            .then(snapshot => {
                donations = snapshot.docs.map(document => {
                let donation = document.data();
                donation.id = document.id;
                
                if(!donation.expired){
                    var allergyInfo = "";
                    if(donation.halal) allergyInfo += "Halal "
                    if(donation.kosher) allergyInfo += "Kosher "
                    if(donation.pescatarian) allergyInfo += "Pescatarian "
                    if(donation.vegan) allergyInfo += "Vegan "
                    if(donation.vegetarian) allergyInfo += "Vegetarian "

                    var contentString = '<div id="content">'+
                        '<div id="siteNotice">'+
                        '</div>'+
                        '<h1 id="firstHeading" class="firstHeading">' + donation.food_item + '</h1>'+
                        '<div id="bodyContent">'+
                        '<p><b>Amount: </b>' + donation.amount + '<br>'+
                        '<b>Additional Info: </b>' + allergyInfo + '<br>'+
                        '<b>Location: </b>' + donation.meeting_point + '<br>'+
                        '<b>Donated by: </b>' + donation.donator + '<br>'+
                        '<b>Pickup Date: </b>' + donation.pickup_date.toDate().toLocaleString() + '<br>'+
                        '<b>Expiration Date: </b>' + donation.expiration_date.toDate().toLocaleString() + '</p>'+
                        '</div>'+
                        '</div>';

                    var infowindow = new google.maps.InfoWindow({
                        content: contentString
                    });

                    var pos = {lat: donation.meeting_point_geopoint.latitude, lng: donation.meeting_point_geopoint.longitude};
                    //console.log(pos.lat + " " + pos.lon);
                    var marker = new google.maps.Marker({
                        position: pos,
                        map: map,
                        title: donation.food_item
                    });
                    marker.addListener('click', function() {
                        infowindow.open(map, marker);
                    });
                }
                });
            });
        }

    script(async, defer, src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCEV6HqDHYuIM1eAGrUw3tGAfIV-l4d88Y&callback=initMap"
    type="text/javascript")